<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>è¥é”€é¡¹ç›®åˆ†æåŠ©æ‰‹</title>
    <!-- æ·»åŠ marked.jsåº“ç”¨äºmarkdownè§£æ -->
    <script src="https://cdn.jsdelivr.net/npm/marked@9.1.6/marked.min.js"></script>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: 'Microsoft YaHei', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); min-height: 100vh; display: flex; align-items: center; justify-content: center; padding: 20px; }
        .container { max-width: 1200px; width: 100%; }
        .header { text-align: center; margin-bottom: 40px; color: white; }
        .header h1 { font-size: 2.5rem; margin-bottom: 10px; font-weight: 300; }
        .header p { font-size: 1.1rem; opacity: 0.9; }
        .dashboard { display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 30px; margin-bottom: 40px; }
        .card { background: rgba(255, 255, 255, 0.95); backdrop-filter: blur(10px); border-radius: 20px; padding: 40px 30px; text-align: center; box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1); border: 1px solid rgba(255, 255, 255, 0.2); transition: all 0.3s ease; position: relative; overflow: hidden; }
        .card:before { content: ''; position: absolute; top: 0; left: 0; width: 100%; height: 4px; background: linear-gradient(90deg, #ff6b6b, #4ecdc4, #45b7d1, #f9ca24); background-size: 400% 400%; animation: gradient 3s ease infinite; }
        @keyframes gradient { 0% { background-position: 0% 50%; } 50% { background-position: 100% 50%; } 100% { background-position: 0% 50%; } }
        .card:hover { transform: translateY(-5px); box-shadow: 0 15px 40px rgba(0, 0, 0, 0.15); }
        .card-icon { font-size: 3rem; margin-bottom: 20px; display: block; }
        .brands-card .card-icon { color: #ff6b6b; }
        .projects-card .card-icon { color: #4ecdc4; }
        .topbrands-card .card-icon { color: #f39c12; }
        .card-number { font-size: 3.5rem; font-weight: 700; color: #2c3e50; margin-bottom: 10px; animation: countUp 2s ease; }
        @keyframes countUp { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }
        .card-label { font-size: 1.2rem; color: #7f8c8d; font-weight: 500; }
        .card-description { font-size: 0.9rem; color: #95a5a6; margin-top: 8px; line-height: 1.4; }
        /* Top5 å“ç‰Œæ–‡æœ¬æ ·å¼ï¼Œè¦†ç›– card-number çš„å¤§å­—å· */
        #topBrands { font-size: 1rem !important; font-weight: 600; color: #2c3e50; margin-bottom: 6px; line-height: 1.4; white-space: normal; word-break: break-word; display: -webkit-box; -webkit-line-clamp: 3; -webkit-box-orient: vertical; overflow: hidden; }
        .info-panel { background: rgba(255, 255, 255, 0.95); backdrop-filter: blur(10px); border-radius: 15px; padding: 30px; box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1); border: 1px solid rgba(255, 255, 255, 0.2); }
        .chat-panel { background: rgba(255, 255, 255, 0.95); backdrop-filter: blur(10px); border-radius: 15px; padding: 20px; box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1); border: 1px solid rgba(255, 255, 255, 0.2); margin-top: 30px; }
        .chat-header { display: flex; align-items: center; gap: 12px; margin-bottom: 20px; color: #2c3e50; font-size: 1.2rem; font-weight: 600; }
        .model-selector-container { font-size: 0.9rem; font-weight: 500; color: #34495e; display: flex; align-items: center; gap: 6px; }
        #modelSelector { padding: 4px 8px; border-radius: 5px; border: 1px solid #bdc3c7; background-color: #ecf0f1; }
        .clear-chat-btn { margin-left: auto; background: #ecf0f1; border: 1px solid #bdc3c7; color: #7f8c8d; padding: 5px 10px; border-radius: 5px; cursor: pointer; font-size: 0.8rem; transition: all 0.2s ease; }
        .clear-chat-btn:hover { background: #e0e5e9; color: #2c3e50; }
        .chat-container { height: 300px; overflow-y: auto; border: 1px solid #ecf0f1; border-radius: 10px; padding: 15px; margin-bottom: 15px; background: #f8f9fa; display: flex; flex-direction: column; gap: 15px; }
        .chat-message { padding: 10px 15px; border-radius: 10px; max-width: 80%; word-wrap: break-word; }
        .user-message { background: linear-gradient(45deg, #667eea, #764ba2); color: white; align-self: flex-end; text-align: left; }
        .ai-message { background: white; color: #2c3e50; border: 1px solid #e9ecef; align-self: flex-start; line-height: 1.6; }
        .ai-message strong { font-weight: 600; color: #2c3e50; }
        .ai-message h1, .ai-message h2, .ai-message h3, .ai-message h4 { margin: 15px 0 10px 0; font-weight: 600; color: #2c3e50; }
        .ai-message h1 { font-size: 1.4em; }
        .ai-message h2 { font-size: 1.3em; }
        .ai-message h3 { font-size: 1.2em; }
        .ai-message h4 { font-size: 1.1em; }
        .ai-message ul, .ai-message ol { margin: 10px 0; padding-left: 20px; }
        .ai-message li { margin: 5px 0; }
        .ai-message p { margin: 8px 0; }
        .ai-message code { background: #f8f9fa; padding: 2px 4px; border-radius: 3px; font-family: 'Monaco', 'Menlo', 'Ubuntu Mono', monospace; font-size: 0.9em; }
        .ai-message pre { background: #f8f9fa; padding: 10px; border-radius: 5px; overflow-x: auto; margin: 10px 0; }
        .ai-message blockquote { border-left: 4px solid #e9ecef; margin: 10px 0; padding: 5px 15px; background: #f8f9fa; }
        .chat-input-container { display: flex; gap: 10px; }
        .chat-input { flex: 1; padding: 12px 15px; border: 1px solid #ddd; border-radius: 25px; font-size: 14px; outline: none; transition: border-color 0.3s ease; }
        .chat-input:focus { border-color: #667eea; }
        .chat-send-btn { padding: 12px 20px; background: linear-gradient(45deg, #667eea, #764ba2); color: white; border: none; border-radius: 25px; cursor: pointer; font-weight: 500; transition: all 0.3s ease; }
        .chat-send-btn:hover { transform: translateY(-2px); box-shadow: 0 4px 15px rgba(0, 0, 0, 0.2); }
        .chat-send-btn:disabled { opacity: 0.6; cursor: not-allowed; transform: none; }
        .info-row { display: flex; justify-content: space-between; align-items: center; padding: 12px 0; border-bottom: 1px solid #ecf0f1; }
        .info-row:last-child { border-bottom: none; }
        .info-label { color: #7f8c8d; font-weight: 500; }
        .info-value { color: #2c3e50; font-weight: 600; }
        .refresh-btn { position: fixed; bottom: 30px; right: 30px; background: linear-gradient(45deg, #667eea, #764ba2); color: white; border: none; border-radius: 50%; width: 60px; height: 60px; font-size: 1.5rem; cursor: pointer; box-shadow: 0 4px 15px rgba(0, 0, 0, 0.2); transition: all 0.3s ease; }
        .refresh-btn:hover { transform: rotate(180deg) scale(1.1); box-shadow: 0 6px 20px rgba(0, 0, 0, 0.3); }
        .loading { display: none; text-align: center; color: white; margin: 20px 0; }
        .spinner { border: 3px solid rgba(255, 255, 255, 0.3); border-radius: 50%; border-top: 3px solid white; width: 30px; height: 30px; animation: spin 1s linear infinite; margin: 0 auto 10px; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        @media (max-width: 768px) { .header h1 { font-size: 2rem; } .card { padding: 30px 20px; } .card-number { font-size: 2.5rem; } .dashboard { grid-template-columns: 1fr; gap: 20px; } }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>è¥é”€é¡¹ç›®åˆ†æåŠ©æ‰‹</h1>
            <p>å®æ—¶ç»Ÿè®¡å“ç‰Œæ•°é‡ä¸é¡¹ç›®æ€»æ•°</p>
        </div>

        <div class="loading" id="loading">
            <div class="spinner"></div>
            <p>æ­£åœ¨æ›´æ–°æ•°æ®...</p>
        </div>

        <div class="dashboard" id="dashboard">
            <div class="card brands-card">
                <span class="card-icon">ğŸ¢</span>
                <div class="card-number" id="brandsCount">-</div>
                <div class="card-label">å“ç‰Œæ€»æ•°</div>
                <div class="card-description">æ¥è‡ªæ‰€æœ‰Excelæ–‡ä»¶çš„å»é‡ç»Ÿè®¡</div>
            </div>

            <div class="card projects-card">
                <span class="card-icon">ğŸ“Š</span>
                <div class="card-number" id="projectsCount">-</div>
                <div class="card-label">é¡¹ç›®æ€»æ•°</div>
                <div class="card-description">åŸºäºé¡¹ç›®é“¾æ¥çš„å”¯ä¸€æ€§ç»Ÿè®¡</div>
            </div>

            <div class="card topbrands-card">
                <span class="card-icon">ğŸ†</span>
                <div class="card-number" id="topBrands">-</div>
                <div class="card-label">å‰5ä¸ªæœ€å¤šé¡¹ç›®çš„å“ç‰Œ</div>
                <div class="card-description">æŒ‰é¡¹ç›®æ•°é‡æ’åºçš„å‰äº”å</div>
            </div>
        </div>

        <div class="info-panel">
            <div class="info-row">
                <span class="info-label">æœ€åæ›´æ–°æ—¶é—´</span>
                <span class="info-value" id="lastUpdated">-</span>
            </div>
            <div class="info-row">
                <span class="info-label">æ•°æ®æ¥æº</span>
                <span class="info-value"><a href="https://www.digitaling.com/" target="_blank">https://www.digitaling.com/</a></span>
            </div>
            <div class="info-row">
                <span class="info-label">ç»Ÿè®¡æ–¹å¼</span>
                <span class="info-value">å“ç‰Œå­—æ®µå»é‡ + é¡¹ç›®é“¾æ¥å»é‡</span>
            </div>
            <div class="info-row">
                <span class="info-label">ç³»ç»ŸçŠ¶æ€</span>
                <span class="info-value" id="systemStatus">æ•°æ®å·²æ›´æ–°</span>
            </div>
        </div>

        <div class="chat-panel">
            <div class="chat-header">
                <span>ğŸ¤– æ™ºèƒ½AIåŠ©æ‰‹</span>
                <div class="model-selector-container">
                    <label for="modelSelector">é€‰æ‹©æ¨¡å‹:</label>
                    <select id="modelSelector">
                        <option value="gemini" selected>Gemini</option>
                        <option value="deepseek">DeepSeek</option>
                    </select>
                </div>
                <button class="clear-chat-btn" onclick="clearChat()">æ¸…é™¤è®°å½•</button>
            </div>
            <div class="chat-container" id="chatContainer">
                <div class="chat-message ai-message">
                    ğŸ‘‹ æ‚¨å¥½ï¼æˆ‘æ˜¯æ™ºèƒ½AIåŠ©æ‰‹ï¼Œå¯ä»¥å¸®æ‚¨æŸ¥è¯¢æ•°è‹±ç½‘é¡¹ç›®æ•°æ®ã€‚æ‚¨å¯ä»¥é—®æˆ‘å…³äºå“ç‰Œã€é¡¹ç›®ã€åˆ›æ„ç­‰ç›¸å…³é—®é¢˜ã€‚
                </div>
            </div>
            <div class="chat-input-container">
                <input type="text" class="chat-input" id="chatInput" placeholder="è¾“å…¥æ‚¨çš„é—®é¢˜..." onkeypress="handleKeyPress(event)">
                <button class="chat-send-btn" id="sendBtn" onclick="sendMessage()">å‘é€</button>
            </div>
        </div>
    </div>

    <button class="refresh-btn" onclick="refreshData()" title="åˆ·æ–°æ•°æ®">ğŸ”„</button>

    <script>
        let chatHistory = [];

        function animateNumber(element, start, end, duration) {
            const startTimestamp = performance.now();
            const step = (timestamp) => {
                const progress = Math.min((timestamp - startTimestamp) / duration, 1);
                const current = Math.floor(progress * (end - start) + start);
                element.textContent = current.toLocaleString();
                if (progress < 1) requestAnimationFrame(step);
            };
            requestAnimationFrame(step);
        }

        function formatTopBrands(topBrandsObj) {
            try {
                if (!topBrandsObj || Object.keys(topBrandsObj).length === 0) return '-';
                // è§„èŒƒåŒ–ä¸º [name, count] æ•°ç»„å¹¶æŒ‰æ•°é‡å€’åº
                const entries = Object.entries(topBrandsObj)
                    .map(([name, count]) => [String(name || 'æœªå‘½å'), Number(count) || 0])
                    .sort((a, b) => b[1] - a[1])
                    .slice(0, 5)
                    .map(([name, count]) => `${name}(${count})`);
                return entries.length ? entries.join('ã€') : '-';
            } catch (e) {
                console.warn('æ ¼å¼åŒ–Topå“ç‰Œå¤±è´¥:', e);
                return '-';
            }
        }

        function loadData() {
            fetch('web_data.json')
                .then(response => response.json())
                .then(data => {
                    const brandsElement = document.getElementById('brandsCount');
                    const projectsElement = document.getElementById('projectsCount');
                    const topBrandsElement = document.getElementById('topBrands');

                    animateNumber(brandsElement, 0, Number(data.brands_count||0), 1500);
                    animateNumber(projectsElement, 0, Number(data.projects_count||0), 1800);
                    topBrandsElement.textContent = formatTopBrands(data.top_brands);
                    topBrandsElement.title = formatTopBrands(data.top_brands);

                    document.getElementById('lastUpdated').textContent = data.last_updated;
                    document.getElementById('systemStatus').textContent = 'æ•°æ®å·²æ›´æ–°';
                })
                .catch(error => {
                    console.error('åŠ è½½æ•°æ®å¤±è´¥:', error);
                    document.getElementById('brandsCount').textContent = 'Error';
                    document.getElementById('projectsCount').textContent = 'Error';
                    document.getElementById('topBrands').textContent = 'Error';
                    document.getElementById('systemStatus').textContent = 'æ•°æ®åŠ è½½å¤±è´¥';
                });
        }

        function refreshData() {
            const loading = document.getElementById('loading');
            const dashboard = document.getElementById('dashboard');
            loading.style.display = 'block';
            dashboard.style.opacity = '0.5';
            fetch('/refresh', { method: 'POST' })
                .then(response => response.json())
                .then(() => { loading.style.display = 'none'; dashboard.style.opacity = '1'; loadData(); })
                .catch(() => { loading.style.display = 'none'; dashboard.style.opacity = '1'; loadData(); });
        }

        function addMessage(message, role) {
            const chatContainer = document.getElementById('chatContainer');
            const messageDiv = document.createElement('div');
            messageDiv.className = `chat-message ${role === 'user' ? 'user-message' : 'ai-message'}`;
            if (role === 'user') messageDiv.textContent = message;
            else {
                try { messageDiv.innerHTML = marked.parse(message); }
                catch { messageDiv.textContent = message; }
            }
            chatContainer.appendChild(messageDiv);
            chatContainer.scrollTop = chatContainer.scrollHeight;
            chatHistory.push({ role: role, content: message });
        }

        function sendMessage() {
            const input = document.getElementById('chatInput');
            const sendBtn = document.getElementById('sendBtn');
            const modelSelector = document.getElementById('modelSelector');
            const message = input.value.trim();
            if (!message) return;
            addMessage(message, 'user');
            input.value = '';
            sendBtn.disabled = true;
            sendBtn.textContent = 'æ€è€ƒä¸­...';
            fetch('/api/chat', {
                method: 'POST', headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ message: message, history: chatHistory.slice(0, -1), model: modelSelector.value })
            })
            .then(response => response.json())
            .then(data => { addMessage(data.success ? data.response : ('âŒ ' + (data.response || 'å¤„ç†è¯·æ±‚æ—¶å‡ºç°é”™è¯¯')), 'assistant'); })
            .catch(() => { addMessage('âŒ ç½‘ç»œè¿æ¥é”™è¯¯ï¼Œè¯·ç¨åé‡è¯•', 'assistant'); })
            .finally(() => { sendBtn.disabled = false; sendBtn.textContent = 'å‘é€'; });
        }

        function clearChat() {
            const chatContainer = document.getElementById('chatContainer');
            chatHistory = [];
            chatContainer.innerHTML = `<div class="chat-message ai-message">ä½ å¥½ï¼ŒèŠå¤©è®°å½•å·²æ¸…ç©ºï¼Œæˆ‘ä»¬å¯ä»¥é‡æ–°å¼€å§‹ã€‚</div>`;
        }

        function handleKeyPress(event) { if (event.key === 'Enter') sendMessage(); }

        document.addEventListener('DOMContentLoaded', loadData);
        setInterval(loadData, 5 * 60 * 1000);
    </script>
</body>
</html>